# Plans and Reports: Auto-Generated vs Manual Entry Fields

This document clearly distinguishes between variables that are automatically generated and those that must be manually entered when creating plans and reports.

---

## 1. Plans (訪問看護計画書)

### 1.1 Automatically Generated Fields

These fields are automatically set by the system and do not require manual input:

| Field | Source | Description |
|-------|--------|-------------|
| `id` | Database | UUID generated by database |
| `user_id` | Authentication | Extracted from authenticated user's JWT token |
| `patient_id` | Request | Provided in API request (validated against user's patients) |
| `title` | Default | Defaults to `"精神科訪問看護計画書"` if not provided |
| `status` | Default | Defaults to `"ACTIVE"` |
| `created_at` | Database | Timestamp set by database trigger |
| `updated_at` | Database | Timestamp set by database trigger |
| `patient_family_wish` | Auto-prefill | Prefilled from `patient.individual_notes` if field is empty |
| `long_term_goal` | Auto-prefill | Prefilled from latest SOAP record's `plan_output['長期目標']` if field is empty |
| `short_term_goal` | Auto-prefill | Prefilled from latest SOAP record's `plan_output['短期目標']` if field is empty |
| `nursing_policy` | Auto-prefill | Prefilled from latest SOAP record's `plan_output['看護援助の方針']` if field is empty |
| `plan_items` | Auto-create | Default 5 items created if not provided:<br>- LONG_TERM (看護の目標)<br>- SHORT_TERM (短期目標)<br>- POLICY (看護援助の方針)<br>- SPECIFIC_CONTENT (具体的な援助内容)<br>- LIFE_RHYTHM (生活リズム)<br><br>OR populated from SOAP record's `plan_output` if available |
| `plan_evaluations` | Auto-create | 2 evaluation slots automatically created:<br>- Slot 1: `start_date + 90 days` (3 months)<br>- Slot 2: `start_date + 180 days` (6 months)<br>- Both initialized with `result = "NONE"` |

**Note:** Auto-prefilled fields (`patient_family_wish`, `long_term_goal`, `short_term_goal`, `nursing_policy`) can be manually overridden. If a value is provided in the request, it takes precedence over the auto-prefill.

### 1.2 Manually Entered Fields

These fields must be provided by the user:

| Field | Required | Description |
|-------|----------|-------------|
| `start_date` | ✅ Yes | Plan start date (YYYY-MM-DD format) |
| `end_date` | ✅ Yes | Plan end date (YYYY-MM-DD format, must be >= start_date) |
| `long_term_goal` | ❌ Optional | Long-term goal (看護の目標) - can be auto-prefilled from SOAP |
| `short_term_goal` | ❌ Optional | Short-term goal (短期目標) - can be auto-prefilled from SOAP |
| `nursing_policy` | ❌ Optional | Nursing policy (看護援助の方針) - can be auto-prefilled from SOAP |
| `patient_family_wish` | ❌ Optional | Patient/family wishes (患者様とご家族の希望) - can be auto-prefilled from patient notes |
| `has_procedure` | ❌ Optional | Boolean flag indicating if procedure/materials are needed (default: false) |
| `procedure_content` | ❌ Optional | Procedure content (処置内容) - required if `has_procedure = true` |
| `material_details` | ❌ Optional | Material details (衛生材料（種類・サイズ）等) - required if `has_procedure = true` |
| `material_amount` | ❌ Optional | Material amount (必要量) - required if `has_procedure = true` |
| `procedure_note` | ❌ Optional | Procedure notes (備考) - required if `has_procedure = true` |
| `plan_items[].observation_text` | ❌ Optional | Observation items (必要な観察項目) for each plan item |
| `plan_items[].assistance_text` | ❌ Optional | Assistance content (援助内容) for each plan item |
| `plan_evaluations[].result` | ❌ Optional | Evaluation result: `"CIRCLE"`, `"CHECK"`, or `"NONE"` (default: `"NONE"`) |
| `plan_evaluations[].note` | ❌ Optional | Evaluation note for each evaluation slot |

### 1.3 Plan Creation Flow

1. **User provides:** `start_date`, `end_date`, and optionally other fields
2. **System auto-prefills:**
   - `patient_family_wish` from `patient.individual_notes` (if empty)
   - `long_term_goal`, `short_term_goal`, `nursing_policy` from latest SOAP record's `plan_output` (if empty)
3. **System auto-creates:**
   - Default `plan_items` (5 items) OR populates from SOAP `plan_output` if available
   - Default `plan_evaluations` (2 slots at +3 months and +6 months)
4. **User can edit:** All fields after creation, including auto-prefilled and auto-created fields

---

## 2. Reports (精神科訪問看護報告書)

### 2.1 Automatically Generated Fields

These fields are automatically set by the system and do not require manual input:

| Field | Source | Description |
|-------|--------|-------------|
| `id` | Database | UUID generated by database |
| `user_id` | Authentication | Extracted from authenticated user's JWT token |
| `patient_id` | Request | Provided in API request (validated against user's patients) |
| `year_month` | Auto-calculate | Calculated from `period_start` (YYYY-MM format) OR provided directly |
| `period_start` | Auto-calculate | Calculated from `year_month` (first day of month) OR provided directly |
| `period_end` | Auto-calculate | Calculated from `year_month` (last day of month) OR provided directly |
| `status` | Default | Defaults to `"DRAFT"` |
| `profession_text` | Default | Defaults to `"訪問した職種：看護師"` |
| `report_date` | Default | Defaults to `CURRENT_DATE` |
| `created_at` | Database | Timestamp set by database trigger |
| `updated_at` | Database | Timestamp set by database trigger |
| `report_visit_marks` | Auto-generate | Automatically generated from `soap_records` for the period:<br>- **CIRCLE (○)**: 1 visit on a date<br>- **DOUBLE_CIRCLE (◎)**: 2+ visits on a date<br>- **CHECK (✔︎)**: Visit duration < 30 minutes<br><br>**Note:** TRIANGLE (△) and SQUARE (□) are manual marks only (not auto-generated) |
| `disease_progress_text` | Auto-prefill | Optionally prefilled from last 10 SOAP records' `soap_output['A']` sections and `notes` fields (concatenated, limited to 2000 chars) |

**Note:** Auto-generated `report_visit_marks` can be manually edited after creation. Auto-prefilled `disease_progress_text` can be manually overridden.

### 2.2 Manually Entered Fields

These fields must be provided by the user:

| Field | Required | Description |
|-------|----------|-------------|
| `year_month` OR `period_start` + `period_end` | ✅ Yes | Report period - either provide `year_month` (YYYY-MM) OR both `period_start` and `period_end` (YYYY-MM-DD) |
| `disease_progress_text` | ❌ Optional | Disease progress (病状の経過) - can be auto-prefilled from SOAP records |
| `nursing_rehab_text` | ❌ Optional | Nursing/rehabilitation content (看護・リハビリテーションの内容) |
| `family_situation_text` | ❌ Optional | Family situation (家庭状況) |
| `procedure_text` | ❌ Optional | Procedure/material info (処置 / 衛生材料（頻度・種類・サイズ）等及び必要量) |
| `monitoring_text` | ❌ Optional | Monitoring notes (特記すべき事項及びモニタリング) |
| `gaf_score` | ❌ Optional | GAF score (integer) |
| `gaf_date` | ❌ Optional | GAF assessment date (YYYY-MM-DD) |
| `profession_text` | ❌ Optional | Profession text - can be manually changed from default |
| `report_date` | ❌ Optional | Report date - can be manually changed from default |
| `status` | ❌ Optional | Report status - can be manually changed from `"DRAFT"` to `"FINAL"` |
| `report_visit_marks[].mark` | ❌ Optional | Visit marks can be manually edited after auto-generation:<br>- Can add/remove CIRCLE, DOUBLE_CIRCLE, CHECK<br>- Can add TRIANGLE (△) or SQUARE (□) manually<br>- Can delete any marks |

### 2.3 Report Creation Flow

1. **User provides:** `year_month` OR `period_start` + `period_end`
2. **System auto-calculates:**
   - If `year_month` provided: calculates `period_start` (first day) and `period_end` (last day)
   - If `period_start` + `period_end` provided: calculates `year_month` from `period_start`
3. **System auto-generates:**
   - `report_visit_marks` from `soap_records` in the period (CIRCLE/DOUBLE_CIRCLE/CHECK based on visit count and duration)
4. **System auto-prefills (optional):**
   - `disease_progress_text` from last 10 SOAP records' A sections and notes
5. **User can edit:** All fields after creation, including auto-generated visit marks and auto-prefilled text

### 2.4 Visit Mark Generation Rules

The system automatically generates visit marks based on SOAP records:

- **CIRCLE (○)**: Generated when there is exactly 1 visit on a date
- **DOUBLE_CIRCLE (◎)**: Generated when there are 2 or more visits on a date
- **CHECK (✔︎)**: Generated when any visit on a date has duration < 30 minutes (can coexist with CIRCLE or DOUBLE_CIRCLE)
- **TRIANGLE (△)**: Manual mark only - not auto-generated
- **SQUARE (□)**: Manual mark only - not auto-generated

**Duration Calculation:**
- Calculated from `soap_records.start_time` and `soap_records.end_time`
- If duration < 30 minutes, CHECK mark is added

**Regeneration:**
- Auto-generated marks (CIRCLE, DOUBLE_CIRCLE, CHECK) can be regenerated via `/reports/{report_id}/regenerate` endpoint
- Manual marks (TRIANGLE, SQUARE) are preserved during regeneration
- Regeneration deletes existing auto-generated marks and recreates them from current SOAP records

---

## 3. Summary Comparison

### Plans

| Category | Fields |
|----------|--------|
| **Auto-Generated** | `id`, `user_id`, `patient_id`, `title` (default), `status` (default), `created_at`, `updated_at`, `plan_items` (default structure), `plan_evaluations` (default slots) |
| **Auto-Prefilled** | `patient_family_wish`, `long_term_goal`, `short_term_goal`, `nursing_policy` (from SOAP/patient data) |
| **Manual Entry** | `start_date`, `end_date`, all goal/policy fields (can override auto-prefill), procedure fields, item content, evaluation results |

### Reports

| Category | Fields |
|----------|--------|
| **Auto-Generated** | `id`, `user_id`, `patient_id`, `year_month`, `period_start`, `period_end`, `status` (default), `profession_text` (default), `report_date` (default), `created_at`, `updated_at`, `report_visit_marks` (from SOAP records) |
| **Auto-Prefilled** | `disease_progress_text` (from SOAP records) |
| **Manual Entry** | Period (year_month OR period_start/end), all text fields (can override auto-prefill), GAF score/date, visit marks (can edit after auto-generation) |

---

## 4. Key Points

1. **Auto-prefilled fields can be overridden:** If a user provides a value for an auto-prefilled field, the manual value takes precedence.

2. **Auto-generated structures can be edited:** Default `plan_items` and `plan_evaluations` can be modified after creation. Auto-generated `report_visit_marks` can be manually edited.

3. **SOAP record dependency:** Both plans and reports rely on SOAP records for auto-prefilling:
   - Plans: Use latest SOAP record's `plan_output` for goals/policy
   - Reports: Use SOAP records in the period for visit marks and disease progress text

4. **Manual marks in reports:** TRIANGLE (△) and SQUARE (□) are never auto-generated - they must be added manually.

5. **Regeneration:** Reports support regeneration of auto-generated marks without losing manual edits (unless `force=true`).

---

**Document Version:** 1.0  
**Last Updated:** 2026-01-XX  
**Maintained By:** Development Team
